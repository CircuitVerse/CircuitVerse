<!-- <% content_for :title, "CircuitVerse - Create Test Set" %> -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<body style="font-family: sans-serif;">
    <br><br>
    <div class="container" style="position: relative;">
        <h1 style="text-align: center"><b>Create Test</b></h1>
        
        <button class="tablink" id="seqSelect" onclick="changeMode('seq')">Sequential Test</button>
        <button class="tablink tab-selected" id="combSelect" onclick="changeMode('comb')">Combinational Test</button>
        <!-- Default table -->
        <table class="tb-table label-table" id="testBenchTable">
            <tr>
                <th colspan="1"></th>
                <th colspan="2" id="tb-inputs-head">INPUTS<button class="table-button" id="plus-1" onclick="addInput()">+</button>
                <th colspan="1" id="tb-outputs-head">OUTPUTS<button class="table-button" id="plus-1" onclick="addOutput()">+</button>
            </tr>
            <tr>
                <th>Label</th>
                <th style="background-color: #aaf" id="tb-inp-label-1"><span contenteditable="true">inp1</span> <a onclick="deleteInput($(this));"><span class="fa fa-minus-square tb-minus"></span></a></th>
                <th style="background-color: #aaf"><span contenteditable="true">inp2</span> <a onclick="deleteInput($(this));"><span class="fa fa-minus-square tb-minus" id="tb-inp-label-2"></span></a></th>
                <th style="background-color: #afa" id="tb-out-label-1"><span contenteditable="true">out1</span> <a onclick="deleteOutput($(this));"><span class="fa fa-minus-square tb-minus"></span></a></th>
            </tr>
            <tr>
                <td>Bitwidth</td>
                <td contenteditable="true">1</td>
                <td contenteditable="true">1</td>
                <td contenteditable="true">1</td>
            </tr>
        </table>
        <div id="dataGroup">
            <div id="data-group-1" class="data-group">
                <h3 id="data-group-title-1" contenteditable="true">Group 1</h3>
                <h5>Click + to add tests to the group</h5>
                <table style="width:100%" contenteditable="true" class="tb-table" id="data-table-1">
                </table>
                <button class="lower-button plus-button latest-button" id="plus-1" onclick="addCase(0)">+</button>
            </div>
        </div>
        <div class="buttons-alignment" style="display: inline-flex;">
            <button class="lower-button" onclick="addGroup()">New Group</button>
        </div>
<!--         <%=  form_for @test_set, url: '/testbench/create', html: { id:'tb-form' } do |f| %>
            <%=  f.hidden_field 'title', id:'tb-title-field', value:'Untitled' %>
            <%=  f.hidden_field 'description', id:'tb-desc-field' %>
            <%=  f.hidden_field 'data', id:'tb-data-field' %>
            <%=  f.hidden_field 'testset_access_type', id:'tb-access-field', value: 'Public' %> -->
            <div style="float: right; display: inline-block;">
                <button class="lower-button save-buton" onclick="parse();">Save</button>
            </div>
        <!-- <% end %> -->
    </div>

</body>
<style>

    .tb-test-title{
        text-align: center;
        margin-top: 50px;
    }

    .lower-button {
        height: 40px;
        width: auto;
        min-width: 40px;
        background-color: #ffffff;
        border: 2px solid black;
        color: black;
        /*padding: 20px;*/
        text-align: center;
        text-decoration: none;
        display: inline-block;
        /*font-size: 16px;*/
        margin: 4px 2px;
        border-radius: 4px;
    }

    .table-button {
        height: 20px;
        width: 20px;
        /*min-width: 40px;*/
        background-color: #ffffff;
        border: 2px solid black;
        color: black;
        /*padding: 20px;*/
        text-align: center;
        text-decoration: none;
        display: inline-block;
        /*font-size: 16px;*/
        margin: 4px 2px;
        border-radius: 5px;
    }


    .plus-button {
        font-size: 25px;
    }

    .tb-minus {
        color: red;
    }

    .save-buton {
        background-color: #42b983;
        color: white;
        border: 1px solid gray;
        min-width: 70px;
    }

    .latest-button {
        float: left;
    }

    .buttons-alignment {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
    }

    .tablink {
      background-color: #555;
      color: white;
      float: left;
      border: 1px solid white;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      font-size: 17px;
      width: 50%;
    }

/* Change background color of buttons on hover */
    .tablink:hover {
      background-color: #a5dfc5;
    }

    .tablink:active {
      outline: none;
    }

    .tablink.tab-selected {
        background-color: #42b983;
        color: #fff;
        outline: none;
    }

    .data-group {
        margin-top: 2%;
    }

    .tb-table th, td {
        border: 2px solid black;
        border-collapse: collapse;
    }
    .tb-table th, td {
        padding: 15px;
        text-align: center;
    }
    .tb-table th {
        text-align: center;
    }

    .tb-table {
        table-layout: fixed;
        width: 100%;
        border-spacing: 5px;
    }

    .label-table {
        margin-top: 100px;
    }


</style>


<script>

    /* Listen to submit click */
    $("#tb-form").submit(function(event) {
      const data = parse();
      $("#tb-data-field").val(JSON.stringify(data));
      /*
        TODO: Add Title, Description, AccessType to hidden fields
      */
    })

    var mode = "comb";
    var groupIndex = 0;
    var inputCount = 2;
    var outputCount = 1;
    var cases = [0];

    function dataReset() {
        groupIndex = 0;
        inputCount = 2;
        outputCount = 1;
        cases = [0];
    }

    /* Change UI mode between Combinational(comb) and Sequential(seq) */
    function changeMode(m) {
        if(mode === m) return;
        dataReset();
        mode = m;
        $(`#combSelect`).removeClass('tab-selected');
        $(`#seqSelect`).removeClass('tab-selected');
        $("#tb-new-group").css("visibility", m === "seq" ? "visible" : "hidden");
        $(`#${m}Select`).addClass('tab-selected');
        $("#dataGroup").empty();
        initTable();

    }

    function initTable() {
        addGroup();
    }

    function addCase(grp) {
        let current_group_table = $(`#data-table-${grp + 1}`);
        let s = `<tr>\n<td>${++cases[grp]}</td>\n`;
        for(let i = 0; i < inputCount + outputCount; i ++) s += "<td>0</td>";
        s += "</tr>"
        current_group_table.append(s);
    }

    /* Adds group with default name 'Group N' or name supplied in @param groupName */
    /* Used without params by UI, used with params by loadData() */
    function addGroup(groupName=`${mode === "comb"? "Group" : "Set"} ${groupIndex + 2}`) {
        $(".plus-button").removeClass("latest-button");
        groupIndex++;

        const s = 
        `
        <div id="data-group-${groupIndex + 1}" class="data-group">
            <h3 id="data-group-title-${groupIndex + 1}" contenteditable="true">${groupName}</h3>
            <h5>Click + to add tests to the ${mode === "comb"? "group" : "set"}</h5>
            <table style="width:100%" contenteditable="true" class="tb-table" id="data-table-${groupIndex + 1}">
            </table>
            <button class="lower-button plus-button latest-button" id="plus-${groupIndex + 1}" onclick="addCase(${groupIndex})" style="font-size: 25px;">+</button>
        </div>
        `;
        cases[groupIndex] = 0;
        $("#dataGroup").append(s);
    }

    /* Adds input with default value 0 or values supplied in @param inputData */
    /* Used without params for UI, used with params by loadData() */
    function addInput(label=`inp${inputCount + 1}`, inputData=[], bitwidth=1) {
        // Change head table contents
        inputCount++;
        const s_head = `<th style="background-color: #aaf" id="tb-inp-label-${inputCount}"><span contenteditable="true">${label}</span> <a onclick="deleteInput($(this));"><span class="fa fa-minus-square tb-minus"></span></a></th>`;
        const s_data = `<td contenteditable="true">${bitwidth}</td>`;
        $("#testBenchTable").find("tr").eq(1).find("th").eq(inputCount - 1).after(s_head);
        $("#testBenchTable").find("tr").eq(2).find("td").eq(inputCount - 1).after(s_data);
        $("#tb-inputs-head").attr("colspan", inputCount);

        // Change data tables' contents

        $("#dataGroup").find("table").each(function() {
            $(this).find("tr").each(function(i) {
                let s = `<td contenteditable="true">${inputData[i] || 0}</td>`;
                $(this).find("td").eq(inputCount - 1).after(s);
            });
        });


    }

    /* Adds output with default value 0 or values supplied in @param outputData */
    /* Used without params for UI, used with params by loadData() */
    function addOutput(label=`out${outputCount + 1}`, outputData=[], bitwidth=1) {
        outputCount++;
        // Change head table contents
        const s_head = `<th style="background-color: #afa" id="tb-inp-label-${outputCount}"><span contenteditable="true">out${outputCount}</span> <a onclick="deleteOutput($(this));"><span class="fa fa-minus-square tb-minus"></span></a></th>`
        const s_data = `<td contenteditable="true">${bitwidth}</td>`;
        $("#testBenchTable").find("tr").eq(1).find("th").eq(inputCount + outputCount - 1).after(s_head);
        $("#testBenchTable").find("tr").eq(2).find("td").eq(inputCount + outputCount - 1).after(s_data);
        $("#tb-outputs-head").attr("colspan", outputCount);

        // Change data tables' contents

        $("#dataGroup").find("table").each(function() {
            $(this).find("tr").each(function(i) {
                let s = `<td contenteditable="true">${outputData[i] || 0}</td>`;
                $(this).find("td").eq(inputCount + outputCount - 1).after(s);
            });
        });

    }

    function deleteInput(element) {
        console.log(element.parent());
    }

    function deleteOutput(element) {
        console.log(element);
    }

    /* Returns input/output(keys) and their bitwidths(values) */
    /* Called by getData() */
    function getBitWidths() {
        let bitwidths = {};
        $("#testBenchTable").find("tr").eq(1).find("th").slice(1).each(function(index) {
            const inp = $(this).text();
            const bw =  $("#testBenchTable").find("tr").eq(2).find("td").slice(1).eq(index).html();
            bitwidths[inp] = Number(bw);
        });
        return bitwidths;
    }

    function getData() {

        const bitwidths = getBitWidths();
        let groups = []
        for(let group_i = 0; group_i <= groupIndex; group_i++){
            let group = {};
            group.label = $(`#data-group-title-${group_i + 1}`).html();
            group.inputs = [];
            group.outputs = [];

            const group_table = $(`#data-table-${group_i + 1}`);
            group.n = group_table.find("tr").length;

            // Push all the inputs in the group
            for(let inp_i = 0; inp_i < inputCount; inp_i++){
                const label = Object.keys(bitwidths)[inp_i];
                let input = { label: label, bitWidth: bitwidths[label], values: [] };
                group_table.find("tr").each(function() {
                    input.values.push($(this).find("td").slice(1).eq(inp_i).html());
                });

                group.inputs.push(input);
            }

            // Push all the outputs in the group
            for(let out_i = 0; out_i < outputCount; out_i++){
                const label = Object.keys(bitwidths)[inputCount + out_i];
                let output = { label: label, bitWidth: bitwidths[label], values: [] };
                group_table.find("tr").each(function() {
                    output.values.push($(this).find("td").slice(1).eq(inputCount + out_i).html());
                });

                group.outputs.push(output);
            }

            groups.push(group);
        }

        return groups;
    }

    /* Parse UI table into Javascript Object */
    function parse() {
        let data = {};
        const tableData = getData();
        data.type = mode;
        data.groups = tableData;

        console.log(data);
        console.log(JSON.stringify(data))
        return data;
    }

    /* Loads data from JSON string into the table */
    function loadData(data) {
        data = JSON.parse(data);
        inputCount = data.inputs.length;
        outputCount = data.outputs.length;
        if(inputCount > 0){
            groupIndex = data.inputs[0].groups.length - 1;
        }
        
    }


</script>
