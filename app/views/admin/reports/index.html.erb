<% content_for :title, "Admin - Reports" %>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>User Reports</h1>
    <div class="d-flex gap-2">
      <%= link_to "All", admin_reports_path, class: "btn btn-outline-secondary #{'active' unless params[:status]}" %>
      <%= link_to "Open", admin_reports_path(status: 'open'), class: "btn btn-outline-warning #{'active' if params[:status] == 'open'}" %>
      <%= link_to "Action Taken", admin_reports_path(status: 'action_taken'), class: "btn btn-outline-success #{'active' if params[:status] == 'action_taken'}" %>
    </div>
  </div>

  <% if flash[:alert] %>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <%= flash[:alert] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <% if @reports.empty? %>
    <div class="alert alert-info">
      <% if defined?(Report) %>
        No reports found.
      <% else %>
        <strong>Report system not yet available.</strong>
        <p class="mb-0">The Report model has not been implemented yet. Please coordinate with your teammate.</p>
      <% end %>
    </div>
  <% else %>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Reporter</th>
            <th>Reported User</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @reports.each do |report| %>
            <tr>
              <td><%= report.id %></td>
              <td><%= report.reporter&.name || 'Unknown' %></td>
              <td>
                <%= report.reported_user&.name || 'Unknown' %>
                <% if report.reported_user&.banned? %>
                  <span class="badge bg-danger">Banned</span>
                <% end %>
              </td>
              <td><%= truncate(report.reason, length: 50) %></td>
              <td>
                <% if report.status == 'open' %>
                  <span class="badge bg-warning text-dark">Open</span>
                <% elsif report.status == 'reviewed' %>
                  <span class="badge bg-info">Reviewed</span>
                <% elsif report.status == 'action_taken' %>
                  <span class="badge bg-success">Action Taken</span>
                <% elsif report.status == 'dismissed' %>
                  <span class="badge bg-secondary">Dismissed</span>
                <% end %>
              </td>
              <td><%= report.created_at.strftime('%Y-%m-%d %H:%M') %></td>
              <td>
                <% if report.reported_user.present? %>
                  <% if report.reported_user.banned? %>
                    <%= button_to "Unban", unban_admin_user_path(report.reported_user),
                                  method: :post,
                                  class: "btn btn-sm btn-success",
                                  data: { confirm: "Are you sure you want to unban #{report.reported_user.name}?" } %>
                  <% else %>
                    <button type="button" class="btn btn-sm btn-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#banModal<%= report.id %>">
                      Ban User
                    </button>
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @reports.respond_to?(:total_pages) %>
      <%= paginate @reports %>
    <% end %>
  <% end %>
</div>

<!-- Ban Confirmation Modals -->
<% if @reports.present? %>
  <% @reports.each do |report| %>
    <% next unless report.reported_user.present? && !report.reported_user.banned? %>
    <div class="modal fade" id="banModal<%= report.id %>" tabindex="-1" aria-labelledby="banModalLabel<%= report.id %>" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <%= form_with url: ban_admin_user_path(report.reported_user), method: :post, local: true do |f| %>
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="banModalLabel<%= report.id %>">
                <i class="fas fa-ban"></i> Ban User: <%= report.reported_user.name %>
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-warning">
                <strong>Warning:</strong> Banning this user will:
                <ul class="mb-0">
                  <li>Immediately log them out of all sessions</li>
                  <li>Prevent them from logging in again</li>
                  <li>Block OAuth and API access</li>
                </ul>
              </div>

              <input type="hidden" name="report_id" value="<%= report.id %>">

              <div class="mb-3">
                <label for="reason<%= report.id %>" class="form-label"><strong>Ban Reason (required)</strong></label>
                <textarea name="reason" id="reason<%= report.id %>" class="form-control" rows="3"
                          placeholder="Explain why this user is being banned..." required></textarea>
                <div class="form-text">This will be recorded in the audit trail.</div>
              </div>

              <% if report.reported_user.ban_history.any? %>
                <div class="card bg-light">
                  <div class="card-header">Previous Ban History</div>
                  <div class="card-body">
                    <ul class="list-unstyled mb-0">
                      <% report.reported_user.ban_history.limit(3).each do |ban| %>
                        <li>
                          <small>
                            <strong><%= ban.created_at.strftime('%Y-%m-%d') %></strong> -
                            <%= truncate(ban.reason, length: 40) %>
                            <% if ban.lifted_at %>
                              <span class="text-success">(Lifted)</span>
                            <% end %>
                          </small>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                </div>
              <% end %>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">
                <i class="fas fa-ban"></i> Confirm Ban
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
